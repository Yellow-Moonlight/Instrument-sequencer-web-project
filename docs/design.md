# 악기 시퀀서 최종 설계 문서 (v2)

이 문서는 반복된 오류를 바로잡고, 최종적으로 합의된 요구사항을 반영한 최종 설계안입니다. 모든 개발은 이 문서를 기준으로 진행됩니다.

## 1. 핵심 원칙

*   **HTML 우선 구조:** `index.html`이 앱의 핵심 레이아웃(컨트롤, 그리드, 트랙 컨트롤 영역)을 정의합니다. JavaScript(`UI.js`)는 이 정적인 구조를 찾아 내용을 채우는 역할만 수행하여 안정성을 확보합니다.
*   **단방향 데이터 흐름:** 모든 상태(State) 변경은 `main.js`가 총괄합니다. `AudioEngine`이나 `UI`는 `main.js`에 정보를 전달할 뿐, 스스로 상태를 변경하지 않습니다. 이는 데이터 흐름을 예측 가능하게 만들어 버그를 원천적으로 방지합니다.
    *   **흐름:** `사용자 입력` -> `main.js` (상태 변경) -> `UI.js` (화면에 렌더링)

## 2. 기능 명세

### 그리드
*   **크기:** 8(가로줄)x10(세로줄)로 고정됩니다. (사용자 크기 조절 기능 제외)

### 샘플 관리
*   **로딩:** 비어있는 셀을 클릭하면, 즉시 파일 업로드 창이 열립니다. (기존 프리셋 샘플 목록 제거)
*   **교체:** 'Replace Sample' 버튼으로 교체 모드를 활성화/비활성화할 수 있습니다. 교체 모드에서 샘플이 있는 셀을 클릭하면 해당 셀의 샘플을 교체할 수 있습니다.

### 재생 및 퀀타이즈
*   **퀀타이즈 단위:** 모든 재생(개별 클립, 씬)은 **다음 1마디(4박자)** 시작점에 맞춰 시작됩니다.
*   **루프:** 한번 재생된 클립은 사용자가 다시 클릭하여 멈추기 전까지 무한 루프됩니다.
*   **자동 속도 조절 (Timestretch):** 샘플을 로드하면, 해당 샘플의 원래 길이를 분석하여 1마디, 2마디, 3마디, 4마디 중 가장 가까운 길이에 맞춰 재생 속도(`playbackRate`)가 자동으로 조절됩니다.

### 컨트롤
*   **볼륨:** 트랙(세로줄)별로 볼륨을 조절할 수 있습니다.
*   **피치:** 클립별 피치 조절 기능은 **제외**합니다.
*   **글로벌:** 전체 재생(첫 번째 씬), 전체 정지, 템포 조절 기능이 제공됩니다.

### 사용자 프리셋
*   **저장:** 현재 그리드의 모든 상태(샘플 정보, 볼륨 등)를 하나의 `.json` 파일로 저장합니다.
*   **로드:** 저장된 `.json` 파일을 불러와 그리드 상태를 복원합니다. (단, 로컬 오디오 파일 자체는 보안 정책상 자동으로 다시 로드되지 않음을 명시)

## 3. UI/UX 명세

*   **레이아웃:** 애플리케이션 전체는 화면에 꽉 차는 **4:3 비율**을 유지하며, 스크롤바가 생기지 않습니다. 그리드 셀은 8줄 모두가 표시되도록 높이가 조절되며, 정사각형이 아닐 수 있습니다.
*   **시각적 피드백:**
    *   그리드 셀에는 로드된 샘플의 파일명이 표시됩니다.
    *   클립이 재생될 때, 루프 주기에 맞춰 셀의 배경색이 채워지는 **재생 진행률 바**가 표시됩니다.
    *   'Replace Sample' 모드가 활성화되면, 교체 가능한 셀에 점선 테두리가 표시되는 등 시각적 힌트를 제공합니다.

## 4. 최종 파일 구조

```
/
├── index.html
├── css/
│   └── style.css
├── js/
│   ├── main.js         # (Controller)
│   ├── AppState.js     # (Model)
│   ├── UI.js           # (View)
│   └── AudioEngine.js  # (Service)
└── docs/
    ├── design.md
    └── ... (other docs)
```

## 5. 프레젠테이션 뷰

*   **목적:** 라이브 공연이나 발표 상황에서 불필요한 컨트롤을 숨겨 시각적 집중도를 높이고, 실수로 인한 조작을 방지합니다.
*   **전환:** 'Presentation View' 버튼을 통해 일반 뷰와 프레젠테이션 뷰를 전환할 수 있습니다.
*   **UI 변경점:**
    *   **숨김 처리:** 글로벌 컨트롤(전체 재생/정지, 템포), 트랙별 볼륨 슬라이더, 샘플 관리 버튼(교체, 저장, 로드) 등 모든 컨트롤 UI가 숨겨집니다.
    *   **유지:** 핵심 8x8 그리드만 화면에 표시됩니다.
*   **상태 관리:** `AppState`에 `viewMode` (e.g., 'edit' or 'presentation') 상태를 추가하여 현재 뷰를 관리합니다.
